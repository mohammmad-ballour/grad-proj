<div class="p-2 border-bottom d-flex justify-content-between align-items-center">
  <h5 class="m-0">Chats</h5>
  <div class="p-2  d-flex justify-content-between align-items-center" d>


    <button (click)=" openNewChatDialog(newChatDialog, false)"
      class="btn btn-success rounded-circle shadow-lg d-flex align-items-center justify-content-center m-1"
      style="width:50px; height:50px;" title="New chat" aria-label="New chat">
      <i class="bi bi-chat-dots" style="font-size:18px; color:#fff;"></i>
    </button>

    <button (click)=" openNewChatDialog(newGroupDialog,true)"
      class="btn btn-success rounded-circle shadow-lg d-flex align-items-center justify-content-center"
      style="width:50px; height:50px;" title="New group" aria-label="New chat">
      <mat-icon>groups</mat-icon>
    </button>
  </div>


  <ng-template #newChatDialog>
    <mat-dialog-content class="p-0" style="max-height: 70vh; overflow-y: auto;">

  <div class="position-sticky top-0 w-100 bg-white p-2" style="z-index: 10;">
  <div class="input-group input-group-sm rounded-pill whatsapp-search">
    
    <!-- Search Icon -->
    <span class="input-group-text bg-transparent border-0 ps-3">
      <i class="fas fa-search text-muted"></i>
    </span>

    <!-- Input -->
    <input 
      #contactsSearch
      matInput
      type="text"
      class="form-control border-0 bg-transparent shadow-none"
      placeholder="Search contacts"
      [(ngModel)]="concatesSearchTerm"
      (ngModelChange)="($event || '').trim() ? getGroupCandidates() : contacts.set([])"
      (keydown.enter)="$event.preventDefault(); concatesSearchTerm.trim() && getGroupCandidates()"
      aria-label="Search for contacts to add to chat or group" />

    <!-- Clear Button -->
    @if(concatesSearchTerm) {
    <button 
      class="btn btn-sm rounded-circle me-2"
      type="button"
      (click)="concatesSearchTerm=''; contactsSearch.focus()"
      title="Clear search"
      aria-label="Clear search"
      style="background-color: rgba(210, 23, 85, 0.968); color: white; width: 35px; height: 35px;"
      (mousedown)="$event.preventDefault()">
      <i class="bi bi-x-lg"></i>
    </button>
    }
  </div>
</div>


      <!-- Group Mode: Drag-and-Drop Interface -->
      @if (isGroupMode) {
      <div class="d-flex flex-column flex-md-row gap-3 p-2">
        <!-- Available Contacts -->
        <div class="flex-1" style="min-height: 200px;">
          <h6 class="fw-semibold d-flex justify-content-between align-items-center">
            Available Contacts
            <span class="badge bg-secondary">{{ contacts().length }}</span>
          </h6>
          <div cdkDropList id="available-contacts" [cdkDropListData]="contacts()"
            [cdkDropListConnectedTo]="['group-members']" (cdkDropListDropped)="drop($event)"
            class="list-group list-group-flush drop-zone" [ngClass]="{'drop-zone-active': dragging()}"
            style="min-height: 150px; border: 1px dashed #ccc; border-radius: 8px;">
            @for (c of contacts(); track c.userAvatar?.userId) {
            @if (c.canBeAddedToGroupByCurrentUser) {
            <div cdkDrag class="list-group-item d-flex align-items-center"
              [cdkDragDisabled]="!c.canBeAddedToGroupByCurrentUser" [cdkDragData]="c" (cdkDragStarted)="onDragStarted()"
              (cdkDragEnded)="onDragEnded()" role="listitem"
              [attr.aria-label]="c.userAvatar.username + ' - drag to add to group'">
              <img [src]="processImage(c.userAvatar.profilePicture)"
                (error)="onImageError($event, 'assets/ProfileAvatar.png')" class="rounded-circle me-2" width="42"
                height="42" [attr.alt]="c.userAvatar.username + ' avatar'" />
              <div class="flex-grow-1 text-start">
                <div class="fw-semibold">{{ c.userAvatar.username }}</div>
                <small class="text-muted">{{ c.profileBio }}</small>
              </div>
              <mat-icon class="drag-handle" cdkDragHandle>drag_indicator</mat-icon>
            </div>
            }
            }
            @if ((contacts() || []).length === 0) {
            <div class="text-center text-muted p-4 drop-zone-empty">
              No contacts found
            </div>
            }
          </div>
        </div>

        <!-- Selected Group Members -->
        <div class="flex-1" style="min-height: 200px;">
          <h6 class="fw-semibold d-flex justify-content-between align-items-center">
            Group Members
            <span class="badge bg-primary">{{ selectedGroupMembers().length }}</span>
          </h6>
          <div cdkDropList id="group-members" [cdkDropListData]="selectedGroupMembers()"
            [cdkDropListConnectedTo]="['available-contacts']" (cdkDropListDropped)="drop($event)"
            class="list-group list-group-flush drop-zone" [ngClass]="{'drop-zone-active': dragging()}"
            style="min-height: 150px; border: 1px dashed #ccc; border-radius: 8px;">
            @for (member of selectedGroupMembers(); track member.userAvatar?.userId) {
            <div cdkDrag class="list-group-item d-flex align-items-center" (cdkDragStarted)="onDragStarted()"
              (cdkDragEnded)="onDragEnded()" role="listitem"
              [attr.aria-label]="member.userAvatar.username + ' - drag to remove from group'">
              <img [src]="processImage(member.userAvatar.profilePicture)"
                (error)="onImageError($event, 'assets/ProfileAvatar.png')" class="rounded-circle me-2" width="42"
                height="42" [attr.alt]="member.userAvatar.username + ' avatar'" />
              <div class="flex-grow-1 text-start">
                <div class="fw-semibold">{{ member.userAvatar.username }}</div>
                <small class="text-muted">{{ member.profileBio }}</small>
              </div>
              <mat-icon class="drag-handle" cdkDragHandle>drag_indicator</mat-icon>
            </div>
            }
            @if (selectedGroupMembers().length === 0) {
            <div class="text-center text-muted p-4 drop-zone-empty">
              Drag contacts here to add to group
            </div>
            }
          </div>
        </div>
      </div>
      } @else {
      <!-- Non-Group Mode: Contact List -->
      <div class="list-group list-group-flush">
        @for (c of contacts(); track c.userAvatar?.userId) {
        @if (c.canBeMessagedByCurrentUser) {
        <button mat-list-item class="list-group-item list-group-item-action d-flex align-items-center"
          [style.cursor]="isGroupMode ? 'pointer' : 'default'"
          [attr.aria-label]="c.userAvatar.username + ' - click to start chat'">
          <img [src]="processImage(c.userAvatar.profilePicture)"
            (error)="onImageError($event, 'assets/ProfileAvatar.png')" class="rounded-circle me-2" width="42"
            height="42" [attr.alt]="c.userAvatar.username + ' avatar'" />
          <div class="flex-grow-1 text-start">
            <div class="fw-semibold">{{ c.userAvatar.username }}</div>
            <small class="text-muted">{{ c.profileBio }}</small>
          </div>
          <button type="button" class="btn btn-sm btn-outline-primary ms-2"
            (click)="$event.stopPropagation(); openChat(c.userAvatar.userId)" aria-label="Start chat with ">
            <mat-icon>chat</mat-icon>
          </button>
        </button>
        }
        }
        @if ((contacts() || []).length === 0) {
        <div class="text-center text-muted p-4">
          No contacts found
        </div>
        }
      </div>
      }
    </mat-dialog-content>

    <mat-dialog-actions align="center" class="d-flex justify-content-evenly p-2">
      @if (isGroupMode) {
      <button type="button" class="btn btn-outline-danger me-2" (click)="clearGroupMembers()"
        [disabled]="selectedGroupMembers().length === 0"
        style="font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;"
        aria-label="Clear all group members">
        Clear All
      </button>
      <button type="button" class="btn telegram-primary-btn" (click)="createGroupChat()"
        [disabled]="!concatesSearchTerm.trim() || selectedGroupMembers().length === 0"
        style="font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;" aria-label="Create group chat">
        Create
      </button>
      }
      <button type="button" class="btn telegram-primary-btn" (click)="cancelDialog(); "
        style="font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;" aria-label="_Close dialog">
        Close
      </button>
    </mat-dialog-actions>
  </ng-template>


  <ng-template #newGroupDialog>
    <div class="modal-content p-4 d-flex flex-column gap-4" style="max-width: 400px;">
      <!-- Header -->
      <h2 class="modal-title m-0" style="font-weight: 600; color: #000;">New Group</h2>

      <div class="d-flex align-items-center gap-3">
        <!-- Avatar upload -->
        <div class="position-relative">
          @if (groupAvatarPreview) {
          <img [src]="groupAvatarPreview" class="rounded-circle shadow-sm"
            style="width: 64px; height: 64px; object-fit: cover;" />
          } @else {
          <div class="rounded-circle d-flex align-items-center justify-content-center"
            style="width: 64px; height: 64px; background-color: #eceff1;">
            <i class="bi bi-people" style="font-size: 32px; color: #546e7a;"></i>
          </div>
          }
          <button class="btn position-absolute telegram-camera-btn p-0" style="bottom: -4px; right: -4px;"
            (click)="GroupAvatar.click()">
            <i class="bi bi-camera-fill" style="font-size: 18px; color: #2c3a9f;"></i>
          </button>
          <input type="file" #GroupAvatar hidden accept="image/*" (change)="onGroupAvatarSelected($event)" />
        </div>

        <!-- Group name input -->
        <div class="form-group flex-grow-1">
          <label for="groupNameInput" class="form-label" style="color: #546E7A; font-size: 14px;">Group
            name</label>
          <input type="text" id="groupNameInput" class="form-control telegram-input" [(ngModel)]="groupName"
            placeholder="Enter group name" maxlength="128" />
          @if (groupName?.length > 0) {
          <small class="form-text text-muted">{{groupName.length}}/128</small>
          }
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer justify-content-end p-3 gap-3">
      <button type="button" class="btn telegram-secondary-btn" (click)="cancelDialog();"
        style="font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">
        Cancel
      </button>
      <button type="button" class="btn telegram-primary-btn" [disabled]="!groupName?.trim() || groupName.length > 128"
        (click)=" closeDialog(); openNewChatDialog( newChatDialog ,true); "
        style="font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">
        Next
      </button>
    </div>
  </ng-template>

  <style>
    .telegram-primary-btn {
      background-color: #156990 !important;
      color: white !important;
      border-radius: 24px !important;
      padding: 10px 28px !important;
      border: none !important;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease !important;
    }

    .telegram-primary-btn:hover {
      background-color: #0288D1 !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2) !important;
      transform: scale(1.02) !important;
    }

    .telegram-primary-btn:active {
      background-color: #0277BD !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
      transform: scale(0.98) !important;
    }

    .telegram-primary-btn:disabled {
      background-color: #B0BEC5 !important;
      color: #ECEFF1 !important;
      cursor: not-allowed !important;
      box-shadow: none !important;
    }

    .telegram-secondary-btn {
      color: #546E7A !important;
      border-radius: 24px !important;
      padding: 10px 20px !important;
      border: none !important;
      transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease !important;
    }

    .telegram-secondary-btn:hover {
      background-color: #ECEFF1 !important;
      color: #0288D1 !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2) !important;
    }

    .telegram-secondary-btn:active {
      background-color: #CFD8DC !important;
      color: #0277BD !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
    }

    .telegram-camera-btn {
      background-color: white !important;
      width: 38px !important;
      height: 38px !important;
      border-radius: 50% !important;
      /* box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3) !important; */
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease !important;
      top: 40px;
      left: 11px;

    }

    .telegram-camera-btn:hover {
      background-color: #dce1e9 !important;
      color: white !important;
      transform: scale(1.005) !important;
    }

    .telegram-camera-btn:active {
      background-color: #ECEFF1 !important;
      transform: scale(0.9) !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
    }

    .telegram-input {
      background-color: #F5F7FA !important;
      border-radius: 8px !important;
      border: none !important;
      padding: 12px !important;
      caret-color: #40C4FF !important;
    }

    .telegram-input:focus {
      border-color: #40C4FF !important;
      box-shadow: 0 0 0 0.25rem rgba(64, 196, 255, 0.25) !important;
    }

    .form-label {
      margin-bottom: 0.25rem !important;
    }

    .form-text {
      margin-top: 0.25rem !important;
    }
  </style>


</div>


<div class="p-2 border-bottom d-flex align-items-center justify-content-between">
  <div class="input-group input-group-sm me-2" style="flex: 1 1 auto;">
    <span class="input-group-text"><i class="fas fa-search"></i></span>
    <input #searchInput type="text" class="form-control" placeholder="Search chats" [(ngModel)]="searchTerm"
      onfocus="if(!this.dataset.bc) this.dataset.bc=getComputedStyle(this).borderColor; this.style.outline='none'; this.style.boxShadow='none'; this.style.borderColor=this.dataset.bc;"
      onblur="this.style.boxShadow='none';" />
    @if(searchTerm) {
    <button class="btn btn-outline-secondary btn-sm" type="button" (click)="searchTerm=''; searchInput.focus()"
      title="Clear search" aria-label="Clear search"
      style="outline:none; box-shadow:none; background-color:#80bd7b  ; border:hidden;"
      (mousedown)="$event.preventDefault()">
      <i class="bi bi-x-lg"></i>
    </button>
    }
  </div>


</div>

<div class="flex-grow-1 overflow-auto   chat-scrollable" (click)="closeContextMenu()">

  <div class="text-center text-muted mt-4">
    @if(!loadingChats()) {
    <svg width="96" height="64" viewBox="0 0 96 64" xmlns="http://www.w3.org/2000/svg" 
      style="margin: 0 auto; display: block;">
      <!-- chat bubble -->
      <rect x="8" y="4" rx="12" ry="12" width="80" height="44" fill="#f1f3f5" />
      <!-- tail -->
      <path d="M32 48 L38 40 L36 48 Z" fill="#f1f3f5" />
      <!-- animated dots -->
      <g transform="translate(18,18)" fill="#6c757d">
        <circle cx="6" cy="8" r="4">
          <animate attributeName="cy" values="8;4;8" dur="1s" repeatCount="indefinite" begin="0s" />
          <animate attributeName="opacity" values="0.3;1;0.3" dur="1s" repeatCount="indefinite" begin="0s" />
        </circle>
        <circle cx="22" cy="8" r="4">
          <animate attributeName="cy" values="8;2;8" dur="1s" repeatCount="indefinite" begin="0.12s" />
          <animate attributeName="opacity" values="0.3;1;0.3" dur="1s" repeatCount="indefinite" begin="0.12s" />
        </circle>
        <circle cx="38" cy="8" r="4">
          <animate attributeName="cy" values="8;4;8" dur="1s" repeatCount="indefinite" begin="0.24s" />
          <animate attributeName="opacity" values="0.3;1;0.3" dur="1s" repeatCount="indefinite" begin="0.24s" />
        </circle>
      </g>
    </svg>
    } @else if(chats().length === 0) {
    <i class="bi bi-chat-dots" style="font-size: 48px;"></i>
    <p class="mt-2">No chats available</p>
    }
  </div>


  @for (chat of filteredChats; track chat.chatId) {
  <div class="chat-item d-flex align-items-center p-2 border-bottom cursor-pointer" (click)="chatClicked(chat)"
    (contextmenu)="openContextMenu($event, chat)">

    <!-- Left: Avatar -->
    <div class="me-2">
      <img [src]="processImage(chat.chatPicture)" (error)="onImageError($event, 'assets/ProfileAvatar.png')"
        class="rounded-circle" width="50" height="50" alt="">
    </div>

    <!-- Middle: Chat Info -->
    <div class="flex-grow-1 d-flex flex-column overflow-hidden">
      <div class="d-flex justify-content-between align-items-center">
        <span class="fw-semibold text-truncate d-flex align-items-center gap-1" style="max-width: 70%;">
          {{ chat.name }}

          <!-- Pinned -->
          @if(chat.pinned) {
          <i style="color: rgb(26, 81, 175);" class="bi bi-pin-angle-fill"></i>
          }
        </span>

        <!-- Time -->
        <small class="text-muted">{{ chat.lastMessageTime | date:'HH:mm' }}</small>
      </div>

      <div class="d-flex justify-content-between align-items-center">
        <!-- Last message -->
        <small class="text-muted text-truncate" style="max-width: 70%;">
          <small class="text-muted text-truncate" style="max-width: 70%;">
            @if(chat.messageType == 'IMAGE') {
            photo <i class="bi bi-image-fill"></i>
            } @else if(chat.messageType == 'VIDEO') {
            video <i class="bi bi-camera-video-fill"></i>
            } @else {
            {{ wrapMessage(chat.lastMessage) }}
            }
          </small>

        </small>

        <div class="d-flex align-items-center gap-1">
          <!-- Unread badge -->
          @if(chat.unreadCount) {
          <span class="badge bg-success rounded-pill px-2">{{ chat.unreadCount }}</span>
          }

          <!-- Muted -->
          @if(chat.muted) {
          <mat-icon class="text-muted" style="font-size: 16px;">notifications_off</mat-icon>
          }
        </div>
      </div>
    </div>

  </div>
  }

  <!-- Context Menu -->
  @if(contextMenuVisible) {
  <div class="position-fixed bg-white border rounded shadow p-2" [style.top.px]="contextMenuPosition.y"
    [style.left.px]="contextMenuPosition.x" style="z-index: 1000; width: 150px;">
    <button class="dropdown-item" (click)="togglePinChat(contextMenuChat)">
      {{ contextMenuChat.pinned ? 'Unpin' : 'Pin to Top' }}
    </button>
    <button class="dropdown-item" (click)="toggleMuteChat(contextMenuChat)">
      {{ contextMenuChat.muted ? 'Unmute' : 'Mute' }}
    </button>
    <button class="dropdown-item" (click)="deleteChat(contextMenuChat.chatId)">
      delete
    </button>
  </div>
  }

</div>