<div class="container-fluid  bg-white rounded shadow-sm" style="height: 100%;">
  <div class="row h-100 rounded">

    <!-- Chat List -->
    <div class="col-3 border-end d-flex flex-column h-100">
      <!-- Header -->
      <div class="p-2 border-bottom d-flex justify-content-between align-items-center">
        <h5 class="m-0">Chats</h5>
        <i class="fas fa-comment-medical cursor-pointer"></i>
      </div>

      <!-- Search -->
      <div class="p-2 border-bottom">
        <div class="input-group input-group-sm">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" class="form-control" placeholder="Search chats">
        </div>
      </div>

      <!-- Chat List (scrollable) -->
      <div class="flex-grow-1 overflow-auto">
        @for (chat of chats(); track chat.chatId) {
        <div class="d-flex align-items-center justify-content-between border-bottom p-2 cursor-pointer"
          (click)="chatClicked(chat)">
          <div class="d-flex gap-2">
            <img [src]="processImage(chat.chatPicture)" (error)="onImageError($event,'assets/ProfileAvatar.png')"
              class="rounded-circle" width="40" height="40" alt="">
            <div class="d-flex flex-column">
              <span>{{ chat.name }}</span>
              <small class="text-muted">{{ chat.lastMessage }}</small>
            </div>
          </div>
          <div class="d-flex flex-column align-items-end">
            <small>{{ chat.lastMessageTime | date:'HH:mm' }}</small>
            @if (chat.unreadCount) {
            <span class="badge bg-success rounded-pill">
              {{ chat.unreadCount }}
            </span>
            }
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Chat Content -->
    <div class="col-9 d-flex flex-column h-100">
      @if ( isChatSelected()) {


      <!-- Chat Header (sticky) -->
      <div class="p-2 border-bottom d-flex align-items-center bg-white sticky-top">
        <img [src]="processImage(chatSelected().chatPicture)" (error)="onImageError($event,'assets/ProfileAvatar.png')"
          class="rounded-circle me-2" width="40" height="40" alt="">
        <strong>{{ chatSelected().name }}</strong>
      </div>

      <!-- Messages (scrollable) -->
<div #scrollContainer class="flex-grow-1 overflow-auto p-3 bg-light chat-scrollbar">
  @for (m of messagesToSelectedChatt(); track m.messageId) {
    <div #messageElement 
         class="d-flex mb-2"
         [class.justify-content-end]="m.senderId == activeUserId"
         [class.justify-content-start]="m.senderId != activeUserId">

      <!-- Chat bubble -->
      <div class="chat-bubble p-2 shadow-sm"
           [class.bg-white]="m.senderId != activeUserId">

        <!-- Reply snippet (if replying to another message) -->
        @if(m.parentMessage) {
          <div class="reply-snippet p-1 border-start border-3 mb-1 text-muted small">
            <div class="fw-bold">{{ m.parentMessage.senderName }}</div>
            <div class="text-truncate" style="max-width: 200px;">
              {{ m.parentMessage.content }}
            </div>
          </div>
        }

        <!-- Message content -->
        <div>{{ m.content }}</div>

        <!-- Time + Status -->
        <div class="chat-meta d-flex align-items-center">
          <span class="me-1">{{ m.sentAt | date:'shortTime' }}</span>
          @if(activeUserId == m.senderId) {
            <i class="bi"
               [ngClass]="{
                 'bi-check-lg': m.messageStatus === MessageStatus.SENT,
                 'bi-check-all': m.messageStatus === MessageStatus.DELIVERED || m.messageStatus === MessageStatus.READ,
                 'text-primary': m.messageStatus === MessageStatus.READ   
               }">
            </i>
          }
        </div>
      </div>

      <!-- Reply button -->
      <button class="btn btn-sm btn-link text-muted ms-1" (click)="setReplyTo(m)">
        <i class="bi bi-reply"></i>
      </button>
    </div>
  }
</div>

 <!-- Reply Preview -->
@if(replyToMessage) {
  <div class="p-2 border-top bg-light small d-flex align-items-center">
    <div class="flex-grow-1">
      <div class="fw-bold">{{ replyToMessage.senderId }}</div>
      <div class="text-muted text-truncate" style="max-width: 250px;">
        {{ replyToMessage.content }}
      </div>
    </div>
    <button class="btn btn-sm btn-link text-danger" (click)="cancelReply()">
      <i class="bi bi-x"></i>
    </button>
  </div>
}

<!-- Input Area -->
<div class="p-2 border-top d-flex bg-white align-items-end">
  <!-- File upload -->
  <input
    type="file"
    #fileInput
    class="d-none"
    (change)="onFileSelected($event)"
  />
  <button class="btn btn-outline-secondary me-2" (click)="fileInput.click()">
    <i class="bi bi-paperclip"></i>
  </button>

  <!-- Message input -->
  <textarea
  class="form-control me-2"
  [(ngModel)]="messageToSent"
  placeholder="Type a message"
  rows="1"
  style="resize: none; overflow-y: auto; max-height: 150px;"
 >
</textarea>


  <!-- Send button -->
  <button
    class="btn btn-success"
    (click)="sendMessage()"
    [disabled]="!messageToSent.trim() && !selectedFile"
  >
    <i class="bi bi-send"></i>
  </button>
</div>

<!-- File Preview -->
@if(selectedFile) {
  <div class="p-2 border-top bg-light small d-flex align-items-center">
    <span class="flex-grow-1">ðŸ“Ž {{ selectedFile.name }}</span>
    <button class="btn btn-sm btn-link text-danger" (click)="selectedFile = undefined">
      <i class="bi bi-x"></i>
    </button>
  </div>
}


      }
    </div>

  </div>
</div>