<!-- Chat Header -->
<div class="p-2 border-bottom d-flex align-items-center bg-white sticky-top">
  <img [src]="processImage(chatSelected.chatPicture)" 
       (error)="onImageError($event, 'assets/ProfileAvatar.png')"
       class="rounded-circle me-2" width="40" height="40" alt="">
  <strong>{{ chatSelected.name }}</strong>
</div>

<!-- Messages Scroll Container -->
<div #scrollContainer
     class="overflow-auto p-3 h-100 bg-light chat-scrollbar"
     (scroll)="onScroll($event)">

  <!-- Loader for older messages -->
  @if(loadingOlderMessages) {
    <div class="text-center py-2">
      <mat-spinner diameter="24"></mat-spinner>
    </div>
  }

  <!-- Loading placeholder -->
  @if(!loadingMessages()) {
    <div class="d-flex align-items-center justify-content-center p-4">
      <svg width="96" height="64" viewBox="0 0 96 64">
        <rect x="8" y="4" rx="12" ry="12" width="80" height="44" fill="#f1f3f5" />
        <path d="M32 48 L38 40 L36 48 Z" fill="#f1f3f5" />
        <g transform="translate(18,18)" fill="#6c757d">
          <circle cx="6" cy="8" r="4">
            <animate attributeName="cy" values="8;4;8" dur="1s" repeatCount="indefinite" begin="0s" />
            <animate attributeName="opacity" values="0.3;1;0.3" dur="1s" repeatCount="indefinite" begin="0s" />
          </circle>
          <circle cx="22" cy="8" r="4">
            <animate attributeName="cy" values="8;2;8" dur="1s" repeatCount="indefinite" begin="0.12s" />
            <animate attributeName="opacity" values="0.3;1;0.3" dur="1s" repeatCount="indefinite" begin="0.12s" />
          </circle>
          <circle cx="38" cy="8" r="4">
            <animate attributeName="cy" values="8;4;8" dur="1s" repeatCount="indefinite" begin="0.24s" />
            <animate attributeName="opacity" values="0.3;1;0.3" dur="1s" repeatCount="indefinite" begin="0.24s" />
          </circle>
        </g>
      </svg>
    </div>
  } @else if(messagesToSelectedChatt().length === 0) {
    <div class="text-center text-muted mt-4">
      <i class="bi bi-chat-dots" style="font-size: 48px;"></i>
      <p class="mt-2 mb-0">No messages yet. Send the first message to start the conversation.</p>
    </div>
  } @else {
    @for(m of messagesToSelectedChatt(); track m.messageId) {
      <div class="d-flex mb-2" [class.justify-content-end]="m.senderAvatar.userId==activeUserId"
           [class.justify-content-start]="m.senderAvatar.userId!=activeUserId">
        
        <!-- Avatar -->
        @if(m.senderAvatar.userId!=activeUserId) {
          <img class="rounded-circle me-2 align-self-end" width="28" height="28"
               [src]="processImage(m.senderAvatar.profilePicture)"
               (error)="onImageError($event,'assets/ProfileAvatar.png')" />
        }

        <!-- Chat Bubble -->
        <div #messageElement class="chat-bubble shadow-sm p-2"
             [ngClass]="{'sent': m.senderAvatar.userId==activeUserId,'received': m.senderAvatar.userId!=activeUserId}"
             [attr.data-message-id]="m.messageId"
           >

          <!-- Reply Preview -->
          @if(m.parentMessageSnippet ) {
            <div class="replied-message p-1 mb-2 rounded bg-secondary bg-opacity-10"
              (click)="viewParent(m.parentMessageSnippet.parentMessageId)"
                 >
              <small class="text-muted">
                <strong>
                  {{
                   m.parentMessageSnippet.parentSenderId==activeUserId ? 'You' :
                    m.parentMessageSnippet.senderDisplayName
                  }}
                </strong>
              </small>
              <div class="text-truncate">
                @if( m.parentMessageSnippet.media) {
                  <img [src]="processImage( m.parentMessageSnippet.media)" class="message-media mb-1"/>
                }
              </div>
              <div class="text-truncate">
                {{   m.parentMessageSnippet.content}}
              </div>
            </div>
          }
          <div
            [matMenuTriggerFor]="msgMenu" #menuTrigger="matMenuTrigger"
             [matMenuTriggerData]="{message: m}"
             (contextmenu)="$event.preventDefault(); menuTrigger.openMenu()"
          
          >


          <!-- Media -->
          @if(m.media) {
            <div class="message-media-wrapper mb-1">
              @if(m.messageType=='IMAGE') {
                <img [src]="processImage(m.media)" class="message-media" />
              } @else if(m.messageType=='VIDEO') {
                <video [src]="processVideo(m.media)" controls class="message-media rounded"></video>
              }
            </div>
          }

          <!-- Text -->
          @if(m.content) {
            <div class="text-content">{{ m.content }}</div>
          }

          <!-- Meta -->
          <div class="chat-meta text-end mt-1">
            <small class="text-muted me-1">{{ m.sentAt | date:'shortTime' }}</small>
            @if(activeUserId==m.senderAvatar.userId) {
              <i class="bi" [ngClass]="{
                'bi-check-lg': m.messageStatus===MessageStatus.SENT,
                'bi-check-all': m.messageStatus===MessageStatus.DELIVERED||m.messageStatus===MessageStatus.READ,
                'text-primary': m.messageStatus===MessageStatus.READ
              }"></i>
            }
          </div>

          </div>
        </div>
      </div>

        <!-- Context menu -->
      <mat-menu #msgMenu="matMenu">
      <ng-template matMenuContent let-data="matMenuTriggerData">
      <button mat-menu-item (click)="startReply(m)"><mat-icon>reply</mat-icon><span>Reply</span></button>
      <button mat-menu-item (click)="copy(m.content)"><mat-icon>content_copy</mat-icon><span>Copy</span></button>
      @if(m.senderAvatar.userId == activeUserId) {
      <button mat-menu-item (click)="openInfoFromContext(menuTrigger, infoMenu, m)">
      <mat-icon>info</mat-icon><span>Info</span>
      </button>
      }
      </ng-template>
      </mat-menu>
      <!-- Component.html -->
      <mat-menu #infoMenu="matMenu">
      <ng-template matMenuContent>
      <div
      style="width: 140px;   max-height: 200px; overflow-y: auto; padding: 12px; font-family: Arial, sans-serif;">
      <h6 style="margin-bottom: 8px; font-weight: 600;">Message Info</h6>

      <!-- Delivered / Read Status -->
      <p style="margin: 4px 0; color: gray;">
      <strong>Delivered:</strong>

      <i class="bi" [ngClass]="{
      'bi-check-lg': !messageInfoData?.delivered ,
      'bi-check-all': messageInfoData?.delivered 
      }"></i>
      </p>
      <p style="margin: 4px 0; color: gray;">
      <strong>Read:</strong>
      <i class="bi bi-check-all" [ngClass]="{
      'text-primary': messageInfoData?.read 
      }"></i>

      </p>

      <!-- Delivered By -->
      @if(deliveredKeys.length > 0) {
      <h6 style="margin-top: 12px; margin-bottom: 4px; font-weight: 500; color: #555;">Delivered By</h6>
      <ul style="list-style: none; padding-left: 0; margin: 0;">
      @for(userId of deliveredKeys ; track userId) {
      <li style="padding: 4px 0; font-size: 14px; color: #333;">
      <strong>User {{ userId }}</strong>
      <span style="float: right; color: gray; font-size: 12px;">
        {{ messageInfoData!.deliveredByAt[userId] | date:'shortTime' }}
      </span>
      </li>
      }
      </ul>
      }

      <!-- Read By -->
      @if(readKeys.length > 0) {
      <h6 style="margin-top: 12px; margin-bottom: 4px; font-weight: 500; color: #555;">Read By</h6>
      <ul style="list-style: none; padding-left: 0; margin: 0;">
      @for(userId of readKeys ;track userId) {
      <li style="padding: 4px 0; font-size: 14px; color: #333;">
      <strong>User {{ userId }}</strong>
      <span style="float: right; color: gray; font-size: 12px;">
        {{ messageInfoData!.readByAt[userId] | date:'shortTime' }}
      </span>
      </li>
      }
      </ul>
      }


      </div>
      </ng-template>
      </mat-menu>
    }
  }
</div>

<!-- Reply Preview -->
@if(replyingToMessage()) {
  <div class="p-2 border-top bg-white d-flex align-items-center">
    <div class="flex-grow-1">
      <small class="text-muted">
        Replying to <strong>{{ replyingToMessage()!.senderAvatar.userId==activeUserId ? 'you' : replyingToMessage()!.senderAvatar.username }}</strong>
      </small>
      <div>{{ replyingToMessage()!.content }}</div>
    </div>
    <button class="btn btn-sm btn-light" (click)="cancelReply()">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
}

<!-- File / Image Preview -->
@if(selectedFile) {
  <div class="p-2 border-top bg-light d-flex align-items-center">
    <div class="me-2">
      @if(isImage(selectedFile)) {
        <img [src]="filePreviewUrl" alt="preview" class="rounded" style="max-height: 80px; max-width: 120px;" />
      } @else {
        <span class="fw-bold">{{ selectedFile.name }}</span>
      }
    </div>
    <button class="btn btn-sm btn-outline-danger ms-auto" (click)="removeAttachment()">
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

<!-- Input Area -->
<div class="p-2 border-top d-flex bg-white align-items-center">
  <button class="btn btn-light me-2" (click)="fileInput.click()">
    <mat-icon>attach_file</mat-icon>
  </button>
  <input type="file" #fileInput hidden accept="image/*,video/*" (change)="onFileSelected($event)" />
  <textarea class="form-control me-2" [(ngModel)]="messageToSent" placeholder="Type a message" rows="1"
            (input)="autoResize($event)" (keyup.enter)="sendMessage()"
            style="resize: none; overflow: hidden;"></textarea>
  <button class="btn btn-success" (click)="sendMessage()">
    <mat-icon>send</mat-icon>
  </button>
</div>

<!-- Message Context Menu -->
<mat-menu #msgMenu="matMenu">
  <ng-template matMenuContent let-message="message">
    <button mat-menu-item (click)="copy(message.content)">Copy</button>
    <button mat-menu-item (click)="startReply(message)">Reply</button>
    <button mat-menu-item (click)="openInfoFromContext(menuTrigger, infoMenu, message)">Info</button>
  </ng-template>
</mat-menu>

<!-- Message Info Menu -->
<mat-menu #infoMenu="matMenu">
  <div class="p-2" style="min-width: 200px;">
    @if(messageInfoData) {
      <h6>Delivered to:</h6>
      <ul>
        @for(key of deliveredKeys; track key) {
          <li>{{ key }} at {{ messageInfoData.deliveredByAt[key] | date:'short' }}</li>
        }
        @if(deliveredKeys.length === 0) {
          <li>None</li>
        }
      </ul>
      <h6>Read by:</h6>
      <ul>
        @for(key of readKeys; track key) {
          <li>{{ key }} at {{ messageInfoData.readByAt[key] | date:'short' }}</li>
        }
        @if(readKeys.length === 0) {
          <li>None</li>
        }
      </ul>
    } @else {
      <p>Loading...</p>
    }
  </div>
</mat-menu>