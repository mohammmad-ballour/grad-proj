<!-- Chat Header -->
<div class="p-2 border-bottom d-flex align-items-center bg-white sticky-top">
  <img [src]="processImage(chatSelected.chatPicture)" 
       (error)="onImageError($event, 'assets/ProfileAvatar.png')"
       class="rounded-circle me-2" width="40" height="40" alt="">
  <div class="d-flex flex-column">
    <strong>{{ chatSelected.name }}</strong>
    <small class="text-muted" (click)="openMembersDialog()" style="cursor: pointer;">   <strong>{{ getMemberNamesPreview() }} </strong></small>
  </div>
</div>

<!-- Messages Scroll Container -->
<div #scrollContainer
     class="overflow-auto p-3 h-100 bg-light chat-scrollbar"
     (scroll)="onScroll($event)">

  <!-- Loading placeholder -->
  @if(!loadingMessages()) {
    <div class="d-flex align-items-center justify-content-center p-4">
      <svg width="96" height="64" viewBox="0 0 96 64">
        <rect x="8" y="4" rx="12" ry="12" width="80" height="44" fill="#f1f3f5" />
        <path d="M32 48 L38 40 L36 48 Z" fill="#f1f3f5" />
        <g transform="translate(18,18)" fill="#6c757d">
          <circle cx="6" cy="8" r="4">
            <animate attributeName="cy" values="8;4;8" dur="1s" repeatCount="indefinite" begin="0s" />
            <animate attributeName="opacity" values="0.3;1;0.3" dur="1s" repeatCount="indefinite" begin="0s" />
          </circle>
          <circle cx="22" cy="8" r="4">
            <animate attributeName="cy" values="8;2;8" dur="1s" repeatCount="indefinite" begin="0.12s" />
            <animate attributeName="opacity" values="0.3;1;0.3" dur="1s" repeatCount="indefinite" begin="0.12s" />
          </circle>
          <circle cx="38" cy="8" r="4">
            <animate attributeName="cy" values="8;4;8" dur="1s" repeatCount="indefinite" begin="0.24s" />
            <animate attributeName="opacity" values="0.3;1;0.3" dur="1s" repeatCount="indefinite" begin="0.24s" />
          </circle>
        </g>
      </svg>
    </div>
  } @else if(messagesToSelectedChatt().length === 0) {
    <div class="text-center text-muted mt-4">
      <i class="bi bi-chat-dots" style="font-size: 48px;"></i>
      <p class="mt-2 mb-0">No messages yet. Send the first message to start the conversation.</p>
    </div>
  } @else {
   @for(item of messagesToSelectedChatt(); track trackByMessage($index, item)){

      @if(isMessage(item)) {
        <div class="d-flex mb-2" [class.justify-content-end]="item.senderAvatar.userId==activeUserId"
             [class.justify-content-start]="item.senderAvatar.userId!=activeUserId">
          
          <!-- Avatar -->
          @if(item.senderAvatar.userId!=activeUserId) {
            <img class="rounded-circle me-2 align-self-end" width="28" height="28"
                 [src]="processImage(item.senderAvatar.profilePicture)"
                 (error)="onImageError($event,'assets/ProfileAvatar.png')" />
          }

          <!-- Chat Bubble -->
          <div #messageElement class="chat-bubble shadow-sm p-2"
               [ngClass]="{'sent': item.senderAvatar.userId==activeUserId,'received': item.senderAvatar.userId!=activeUserId}"
               [attr.data-message-id]="item.messageId">

            <!-- Reply Preview -->
            @if(item.parentMessageSnippet ) {
              <div class="replied-message p-1 mb-2 rounded bg-secondary bg-opacity-10"
                   (click)="viewParent(item.parentMessageSnippet.parentMessageId)">
                <small class="text-muted">
                  <strong>
                    {{
                     item.parentMessageSnippet.senderDisplayName=='activeuserId' ? 'You' :
                      item.parentMessageSnippet.senderDisplayName
                    }}
                  </strong>
                </small>
                <div class="text-truncate">
                  @if( item.parentMessageSnippet.media) {
                    <img [src]="processImage( item.parentMessageSnippet.media)" class="message-media mb-1"/>
                  }
                </div>
                <div class="text-truncate">
                  {{   item.parentMessageSnippet.content}}
                </div>
              </div>
            }
            <div
                [matMenuTriggerFor]="msgMenu"
                #menuTrigger="matMenuTrigger"
                [matMenuTriggerData]="{message: item}"
                (contextmenu)="$event.preventDefault(); menuTrigger.openMenu()"
                (menuOpened)="onMenuOpened(menuTrigger, item)"
                (menuClosed)="onMenuClosed(menuTrigger)">
            <!-- Media -->
            @if(item.media) {
              <div class="message-media-wrapper mb-1">
                @if(item.messageType=='IMAGE') {
                  <img [src]="processImage(item.media)" class="message-media" />
                } @else if(item.messageType=='VIDEO') {
                  <video [src]="processVideo(item.media)" controls class="message-media rounded"></video>
                }
              </div>
            }

            <!-- Text -->
            @if(item.content) {
              <div class="text-content">{{ item.content }}</div>
            }

            <!-- Meta -->
            <div class="chat-meta text-end mt-1">
              <small class="text-muted me-1">{{ item.sentAt | date:'shortTime' }}</small>
              @if(activeUserId==item.senderAvatar.userId) {
                <i class="bi" [ngClass]="{
                  'bi-check-lg': item.messageStatus===MessageStatus.SENT,
                  'bi-check-all': item.messageStatus===MessageStatus.DELIVERED||item.messageStatus===MessageStatus.READ,
                  'text-primary': item.messageStatus===MessageStatus.READ
                }"></i>
              }
            </div>

            </div>
          </div>
        </div>
      } @else {
 <div #messageElement
     class="d-flex flex-column align-items-center justify-content-center py-3 w-100"
     [attr.data-gap-type]="item.type"
     [attr.data-missing-count]="item.missingCount"
     [attr.data-last-message-id]="item.lastMessageId"
     [attr.data-last-message-sent-at]="item.lastMessageSentAt">

  <mat-spinner diameter="24"></mat-spinner>
  <span class="mt-2 text-muted">Loading messages...</span>
</div>




      }
    }
  }
</div>

<!-- Reply Preview -->
@if(replyingToMessage()) {
  <div class="p-2 border-top bg-white d-flex align-items-center">
    <div class="flex-grow-1">
      <small class="text-muted">
        Replying to <strong>{{ replyingToMessage()!.senderAvatar.userId==activeUserId ? 'you' : replyingToMessage()!.senderAvatar.username }}</strong>
      </small>
      <div>{{ replyingToMessage()!.content }}</div>
    </div>
    <button class="btn btn-sm btn-light" (click)="cancelReply()">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
}

<!-- File / Image Preview -->
@if(selectedFile) {
  <div class="p-2 border-top bg-light d-flex align-items-center">
    <div class="me-2">
      @if(isImage(selectedFile)) {
        <img [src]="filePreviewUrl" alt="preview" class="rounded" style="max-height: 80px; max-width: 120px;" />
      } @else {
        <span class="fw-bold">{{ selectedFile.name }}</span>
      }
    </div>
    <button class="btn btn-sm btn-outline-danger ms-auto" (click)="removeAttachment()">
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

<!-- Input Area -->
<div class="p-2 border-top d-flex bg-white align-items-center">
  <button class="btn btn-light me-2" (click)="fileInput.click()">
    <mat-icon>attach_file</mat-icon>
  </button>
  <input type="file" #fileInput hidden accept="image/*,video/*" (change)="onFileSelected($event)" />
  <textarea class="form-control me-2" [(ngModel)]="messageToSent" placeholder="Type a message" rows="1"
            (input)="autoResize($event)" (keyup.enter)="sendMessage()"
            style="resize: none; overflow: hidden;"></textarea>
  <button class="btn btn-success" (click)="sendMessage()">
    <mat-icon>send</mat-icon>
  </button>
</div>

<!-- Message Context Menu -->
<mat-menu #msgMenu="matMenu">
  <ng-template matMenuContent let-message="message">
    <button mat-menu-item (click)="copy(message.content)"><mat-icon>content_copy</mat-icon>Copy</button>
    <button mat-menu-item (click)="startReply(message)"><mat-icon>reply</mat-icon>Reply</button>
    @if(message.senderAvatar.userId == activeUserId) {
      <button mat-menu-item (click)="openInfoFromContextInfo(infoMenu, message)">
    <mat-icon>info</mat-icon>Info
  </button>
     }
  </ng-template>
</mat-menu>

<!-- Message Info Menu -->
<mat-menu #infoMenu="matMenu">
  <div class="p-2" style="min-width: 200px;">
    @if(messageInfoData) {
      <h6>Delivered to:</h6>
      <ul>
        @for(key of deliveredKeys; track key) {
          <li>{{ GetMemberName(key)   }} at {{ messageInfoData.deliveredByAt[key] | date:'short' }}</li>
        }
        @if(deliveredKeys.length === 0) {
          <li>None</li>
        }
      </ul>
      <h6>Read by:</h6>
      <ul>
        @for(key of readKeys; track key) {
          <li>{{ GetMemberName(key)  }} <br> at {{ messageInfoData.readByAt[key] | date:'short' }}</li>
        }
        @if(readKeys.length === 0) {
          <li>None</li>
        }
      </ul>
    } @else {
      <p>Loading...</p>
    }
  </div>
</mat-menu>