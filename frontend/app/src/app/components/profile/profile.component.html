@if ( initialSpinner) {
<div class="loading-state-overlay">
  <mat-spinner></mat-spinner>
  <p style="color: white;">Loading profile...</p>
</div>
}

@else {

@if(isNotFound){
<div class="not-found-container">
  <h2>User Not Found</h2>
  <p>The profile you are looking for does not exist or has been removed.</p>
  <mat-icon>person_off</mat-icon>
</div>
}
@else {
<div  #scrollContainer class="profile-container"    (scroll)="onScroll()">
  <div class="profile-header "  >
    <img [src]="profile.profileCoverPhoto " (error)="onImageError($event,'assets/coverPhoto.png')" class="cover-img  " />

    <div class="avatar-section">
      <img [src]="profile.userAvatar.profilePicture" (error)="onImageError($event,'assets/ProfileAvatar.png')"
        class="avatar-img" />

    </div>

    <div class="user-info">
      <div class="profile-actions">
        @if (isPersonalProfile) {
        <button (click)="openEditProfile()">Edit Profile</button>
        } @else {
        @if(profile.isBlocked){
        <button style="color: white; background-color: red;" class="block-btn" (click)="toggleBlock()"
          [disabled]="blockSpinner">
          @if (blockSpinner) {
          <mat-progress-spinner color="primary" diameter="18" strokeWidth="3" mode="indeterminate"
            class="block-spinner">
          </mat-progress-spinner>
          }@else{
          Unblock
          }

        </button>
        } @else{
        @if (!profile.isBeingFollowed) {
        <button mat-flat-button color="primary" class="follow-btn" (click)="toggleFollow(true)"
          [disabled]="followSpinner">
          @if (followSpinner) {
          <mat-progress-spinner diameter="18" strokeWidth="3" mode="indeterminate" color="accent"
            class="follow-spinner">
          </mat-progress-spinner>
          }@else{
          Follow
          }

        </button>
        }@else {

        <button mat-icon-button [matMenuTriggerFor]="Priority" class="unfollow-btn" (click)="menuOpen=!menuOpen"
          #menuTrigger="matMenuTrigger">
          @if (followSpinner) {
          <mat-progress-spinner diameter="18" strokeWidth="3" mode="indeterminate" color="accent"
            class="follow-spinner">
          </mat-progress-spinner>
          }@else {
          unfollow
          <mat-icon class="arrow-icon" [class.rotate]="menuOpen"> keyboard_double_arrow_down</mat-icon>
          }

        </button>
        }


        <div class="controls">
          <!-- Block and Category Actions -->
          <div class="block-category-group">
            <!-- messenger-button.component.html -->
             @if(!profile.isBlocked){
               <button class="messenger-btn" [disabled]="!profile.canBeMessaged" [title]="profile.canBeMessaged ?'message' : 'You are not allowed to message this user' " (click)="openChat()" >
             <i class="bi bi-messenger text-primary fs-3"></i>

            </button>
             }


            <!-- Category Menu -->
            <button mat-icon-button [matMenuTriggerFor]="menu" #menuTrigger="matMenuTrigger">

              @if(menuSpinner){
              <mat-progress-spinner color="primary" diameter="18" strokeWidth="3" mode="indeterminate"
                class="menu-spinner">
              </mat-progress-spinner>
              }
              @else{
              <mat-icon>more_vert</mat-icon>
              }
            </button>

            <mat-menu #menu="matMenu">
              @if(!menuSpinner){
              <!-- Block User -->
              <button mat-menu-item class="mat-button" (click)="toggleBlock()">
                <mat-icon style="color: red;">block</mat-icon>
                block <span>{{'@'+profile.username}}</span>
              </button>
              @if ( !profile.isBlocked) {

              <button mat-menu-item class="mat-button" class="mute"
                (click)="profile.isMuted ? unmute(true): openMuteDialog()">
                <mat-icon style="color: rgb(26, 167, 214);">{{ profile.isMuted ? 'notifications_off' :
                  'notifications_on' }}</mat-icon>
                {{profile.isMuted? 'unMute' : 'mute'}}
              </button>


              }
              }
            </mat-menu>


            <mat-menu #Priority="matMenu">
              <!-- Restricted -->
              <button mat-menu-item class="mat-button" (click)="updatePriority('RESTRICTED')"
                [disabled]="profile.followingPriority=='RESTRICTED'">
                <mat-icon style="color: rgb(1, 0, 0);">lock</mat-icon>
                <span>Restrict account</span>
                @if (profile.followingPriority === 'RESTRICTED') {
                <mat-icon style="color: rgb(21, 85, 168);">bookmark_check</mat-icon>
                }
              </button>

              <!-- Favourite -->
              <button mat-menu-item class="mat-button" (click)="updatePriority('FAVOURITE')"
                [disabled]="profile.followingPriority=='FAVOURITE'">
                <mat-icon style="color: rgb(17, 199, 138);">favorite</mat-icon>
                Add to faavourites
                @if (profile.followingPriority === 'FAVOURITE') {
                <mat-icon style="color
                :  rgb(21, 85, 168);">bookmark_check</mat-icon>
                }


              </button>

              <!-- Default -->
              <button mat-menu-item class="mat-button" (click)="updatePriority('DEFAULT')"
                [disabled]="profile.followingPriority=='DEFAULT'">
                <mat-icon style="color: rgb(72, 168, 237);">star</mat-icon>
                @if (profile.followingPriority === 'DEFAULT') {
                <mat-icon style="color: rgb(21, 85, 168);">bookmark_check</mat-icon>
                }
                <span>Default</span>

              </button>

              <button mat-menu-item class="mat-button" (click)="toggleFollow(true)">
                <mat-icon style="color: rgb(222, 21, 21);">person_remove</mat-icon>
                unfollow
              </button>

            </mat-menu>

          </div>


        </div>
        }

        }
      </div>

      <h1 class="username">
        {{ profile.userAvatar.displayName }}
        @if (profile.aboutUser.gender === 'MALE') {
        <mat-icon>male</mat-icon>
        }
        @if (profile.aboutUser.gender === 'FEMALE') {
        <mat-icon>female</mat-icon>
        }
      </h1>

      <span class="handle">{{ '@' + profile.username }}</span>
      <p class="bio">{{ profile.profileBio }}</p>

      <div class="field-joined">
        <mat-icon>calendar_today</mat-icon>
        <span>Joined {{ profile.joinedAt | date: 'MMMM yyyy' }}</span>
        @if (profile.aboutUser.residence) {
        <span> Â· <mat-icon inline>location_on</mat-icon> {{ profile.aboutUser.residence }}</span>
        }
      </div>
      <div class="stats">
        <!-- Followers -->
        <span (click)="!isFollowersLoading && !profile.isBlocked && loadFollowers()"
          [style.cursor]="profile.isBlocked ? 'not-allowed' : 'pointer'" [style.opacity]="profile.isBlocked ? 0.5 : 1"
          style="display: inline-flex; align-items: center; gap: 4px;">
          @if (isFollowersLoading) {
          <mat-spinner diameter="16"></mat-spinner>
          } @else {
          <b>{{ profile.followerNo ?? 0 }}</b> Followers
          }
        </span>

        <!-- Following -->
        <span (click)="!isFollowingLoading && !profile.isBlocked && loadFollowing()"
          [style.cursor]="profile.isBlocked ? 'not-allowed' : 'pointer'" [style.opacity]="profile.isBlocked ? 0.5 : 1"
          style="display: inline-flex; align-items: center; gap: 4px;">
          @if (isFollowingLoading) {
          <mat-spinner diameter="16"></mat-spinner>
          } @else {
          <b>{{ profile.followingNo ?? 0 }}</b> Following
          }
        </span>
      </div>
      @if(!isPersonalProfile&& MutualFollowings&& !profile.isBlocked){
        <div [style.cursor]="'pointer'"  (click)="loadMutualFollowings()" style="margin-top:20px; color: rgb(151, 195, 246);"> <span style="color: gray;">Followed by</span> {{MutualFollowings}}

        </div>
      }

    </div>
  </div>

 <mat-tab-group (selectedIndexChange)="onTabChange($event)">
  <!-- Posts -->
  <mat-tab label="Posts"  style="padding: 20px;">
    @if (isPostsLoading && posts.length === 0) {
      <div>Loading posts...</div>
    } @else {
      @for (post of posts; track post.statusId) {
        <app-status-card [statusData]="post" (deleted)="onStatusDeleted($event)"></app-status-card>
      }
      @if (isPostsLoading && posts.length > 0) {
        <div>Loading more posts...</div>
      }
      @if (!hasMorePosts) {
        <div class="end-message">No more posts</div>
      }
    }
  </mat-tab>

  <!-- Replies -->
  <mat-tab label="Replies">
    @if (isRepliesLoading && replies.length === 0) {
      <div>Loading replies...</div>
    } @else {
      @for (reply of replies; track reply.statusId) {
        <app-status-card [statusData]="reply" (deleted)="onStatusDeleted($event)" 
        
        ></app-status-card>
      }
      @if (isRepliesLoading && replies.length > 0) {
        <div>Loading more replies...</div>
      }
      @if (!hasMoreReplies) {
        <div class="end-message">No more replies</div>
      }
    }
  </mat-tab>

  <!-- Media -->
  <mat-tab label="Media">
    @if (isMediaLoading && media.length === 0) {
      <div>Loading media...</div>
    } @else {
      <div class="media-grid">
        @for (m of media; track m.mediaId) {
          @if (m.mimeType.startsWith('image/')) {
            <img [src]="mediaService.getMediaById(m.mediaId)" width="200"  style="cursor: pointer;" (click)="displayOwendStatus(m.statusId)" />
          }
          @if (m.mimeType.startsWith('video/')) {
            <video width="200" controls>
              <source [src]="mediaService.getMediaById(m.mediaId)" [type]="m.mimeType" />
            </video>
          }
        }
      </div>
      @if (isMediaLoading && media.length > 0) {
        <div>Loading more media...</div>
      }
      @if (!hasMoreMedia) {
        <div class="end-message">No more media</div>
      }
    }
  </mat-tab>

  <!-- Likes -->
  @if (isPersonalProfile) {
    <mat-tab label="Likes">
      @if (isLikesLoading && likes.length === 0) {
        <div>Loading likes...</div>
      } @else {
        @for (like of likes; track like.statusId) {
          <app-status-card [statusData]="like"></app-status-card>
        }
        @if (isLikesLoading && likes.length > 0) {
          <div>Loading more likes...</div>
        }
        @if (!hasMoreLikes) {
          <div class="end-message">No more likes</div>
        }
      }
    </mat-tab>
  }
</mat-tab-group>

<!-- Back to top floating button -->
@if (showBackToTop) {
  <button mat-fab color="primary" class="back-to-top" (click)="scrollToTop()">
    <mat-icon>arrow_upward</mat-icon>
  </button>
}



</div>

}

}